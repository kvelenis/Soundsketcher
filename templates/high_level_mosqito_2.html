<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loudness Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Upload an Audio File and View Loudness per Frequency Band</h1>
    <form id="upload-form" action="/analyze_audio" method="post" enctype="multipart/form-data">
        <label for="wav_file">Select a WAV file:</label>
        <input type="file" id="wav_file" name="wav_file" accept=".wav" required>
        <br><br>
        <button type="submit">Upload and Analyze</button>
    </form>

    <h2>Loudness Results</h2>
    <audio id="audio-player" controls style="display: none;">
        <source id="audio-source" type="audio/wav">
        Your browser does not support the audio element.
    </audio>
    <div id="plot"></div>

    <script>
        let loudnessData;
        let plotLine = null;

        document.getElementById("upload-form").onsubmit = async function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const response = await fetch("/analyze_audio", {
                method: "POST",
                body: formData
            });

            if (response.ok) {
                loudnessData = await response.json();
                renderPlot(loudnessData);
                // Load the audio file into the player
                const audioFile = formData.get('wav_file');
                const audioURL = URL.createObjectURL(audioFile);
                document.getElementById('audio-source').src = audioURL;
                const audioPlayer = document.getElementById('audio-player');
                audioPlayer.style.display = 'block';
                audioPlayer.load();
                audioPlayer.addEventListener('timeupdate', () => updatePlot(audioPlayer.currentTime));
            } else {
                alert("Failed to analyze audio file.");
            }
        };

        function renderPlot(data) {
            let traces = [];
            for (let band in data) {
                traces.push({
                    x: data[band].time_axis,
                    y: data[band].loudness,
                    mode: 'lines',
                    name: band
                });
            }

            const layout = {
                title: 'Loudness per Frequency Band Over Time',
                xaxis: { title: 'Time (s)' },
                yaxis: { title: 'Loudness (Sones)' },
                shapes: []  // This will be updated for the playhead line
            };

            Plotly.newPlot('plot', traces, layout);
        }

        function updatePlot(currentTime) {
            // Remove the previous playhead line if it exists
            if (plotLine !== null) {
                Plotly.relayout('plot', {
                    'shapes[0]': null
                });
            }

            // Add a new playhead line at the current time
            plotLine = {
                type: 'line',
                x0: currentTime,
                x1: currentTime,
                y0: 0,
                y1: 1,
                yref: 'paper',
                line: {
                    color: 'red',
                    width: 2
                }
            };

            Plotly.relayout('plot', {
                shapes: [plotLine]
            });
        }
    </script>
</body>
</html>
