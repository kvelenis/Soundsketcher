<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Clustering Visualization</title>
    <script src="https://cdn.plot.ly/plotly-2.25.2.min.js"></script>
</head>
<body>
    <div id="plot" style="width:100%;height:100%;"></div>
    <script>
        const fetchData = async () => {
            try {
                // Fetch JSON data dynamically
                const response = await fetch(`/plotly-data/{{ audio_file }}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('plot').innerText = "Error loading data: " + data.error;
                    return;
                }

                // Extract waveform and time axis
                const { waveform, sample_rate, clusters } = data;
                const timeAxis = Array.from({ length: waveform.length }, (_, i) => i / sample_rate);

                // Waveform trace
                const waveformTrace = {
                    x: timeAxis,
                    y: waveform,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Waveform',
                    line: { color: '#000000', width: 1 },
                };

                // Cluster traces
                const clusterTraces = clusters.flatMap(cluster => {
                    return cluster.regions.map(region => {
                        const startIdx = Math.floor(region.start_time * sample_rate);
                        const endIdx = Math.ceil(region.end_time * sample_rate);
                        return {
                            x: timeAxis.slice(startIdx, endIdx),
                            y: waveform.slice(startIdx, endIdx),
                            mode: 'lines',
                            name: `Cluster ${cluster.label}`,
                            line: { color: cluster.color, width: 1 },
                            hoverinfo: 'name+text',
                            text: cluster.top_terms.map(term => `${term.term}: ${term.similarity.toFixed(2)}`).join('<br>')
                        };
                    });
                });

                // Layout configuration
                const layout = {
                    title: `Audio Clustering Visualization: ${data.audio_file}`,
                    xaxis: { title: 'Time (s)' },
                    yaxis: { title: 'Amplitude' },
                    showlegend: true,
                };

                // Render the plot
                Plotly.newPlot('plot', [waveformTrace, ...clusterTraces], layout);
            } catch (error) {
                console.error("Error fetching or rendering data:", error);
                document.getElementById('plot').innerText = "Error rendering the plot.";
            }
        };

        // Call fetchData to initialize the plot
        fetchData();
    </script>
</body>
</html>