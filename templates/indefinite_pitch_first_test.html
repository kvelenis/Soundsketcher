<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Questionnaire UI</title>
  <style>
    body {
      margin: 0;
      font-family: Helvetica, sans-serif;
      background-color: #f4f4f4;
    }

    .questionnaire__container {
      position: relative;
      width: 100%;
      min-width: 685px;
      min-height: 600px;
      padding: 40px;
      box-sizing: border-box;
      /* background-color: #ffffff; */
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .questionnaire__main-content {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      align-items: center;
      min-height: 500px;
    }

    .questionnaire__title {
      text-align: center;
      width: 770px;
    }

    button.questionnaire__audio-play-button {
      width: 90px;
      height: 100px;
      background: #ffffff;
      border: 1px solid #000;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 3px 3px 4px rgba(61, 69, 116, 0.4);
    }

    button.questionnaire__loop-toggle {
      width: 90px;
      padding: 10px 15px;
      font-size: 12px;
      border: 1px solid #000;
      background: #ffffff;
      cursor: pointer;
      box-shadow: 3px 3px 4px rgba(61, 69, 116, 0.4);
    }

    .loop-toggle-wrapper {
      display: flex;
      align-items: center;
      gap: 8px; /* space between arrow and button */
    }

    .loop-arrow {
      font-size: 16px;
      color: #3D4574;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }




    .questionnaire__sinewave-slider {
      width: 1250px;
    }

    button.questionnaire__no-match-button {
      width: 214px;
      height: 100px;
      background: #ffffff;
      border: 1px solid #000;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 3px 3px 4px rgba(61, 69, 116, 0.4);
    }

    .questionnaire__no-match-button.active {
      background-color: #ff4d4d; /* red */
      color: white;
      border-color: #aa0000;
    }


    button.questionnaire__submit-button {
      width: 350px;
      height: 100px;
      background: #ffffff;
      border: 1px solid #000;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 3px 3px 4px rgba(61, 69, 116, 0.4);
    }

    .questionnaire__info-box {
      position: absolute;
      cursor: pointer;
      right: 40px;
      top: 40px;
      width: 60px;
      height: 60px;
      border: 1px solid #000;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .slider-horizontal {
      position: absolute;
      left: 260px;
      top: 260px;
      width: 160px;
    }

    .slider-label {
      position: absolute;
      left: 336px;
      top: 240px;
      font-size: 12px;
      width: 180px;
      text-align: center;
    }

    .slider-vertical-wrapper {
      position: absolute;
      width: 30px;
      height: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .slider-vertical {
      writing-mode: bt-lr; /* Bottom to top */
      transform: rotate(270deg);
      width: 100px;
    }

    #synth-slider {
      left: 365px;
      top: 340px;
    }

    #sound-slider {
      left: 425px;
      top: 340px;
    }

    /* Modal Styling */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modal-content {
      width: 500px;
      background-color: white;
      padding: 30px 40px;
      border-radius: 8px;
      text-align: center;
      max-width: 600px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .modal h2 {
      margin-top: 0;
    }

    .modal p {
      margin: 20px 0;
    }

    .start-btn {
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      background-color: #3D4574;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .start-btn:hover {
      background-color: #2c3455;
    }

    #sampleIcon {
      font-size: 20px;
    }

    .slider-locked {
      opacity: 0.5;
    }

    #infoBoxModal{
      display: none;
    }

    @keyframes pulseGreen {
      0%   { background-color: #a8f0a2; }
      50%  { background-color: #38c24f; }
      100% { background-color: #a8f0a2; }
    }

    .training-active {
      animation: pulseGreen 1.2s infinite;
      color: #000;
      font-weight: bold;
      border: 2px solid #38c24f;
    }

    #soundProgressBox.training-active {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #d4f4d1;
      border: 2px solid #2f6b28;
      font-size: 20px;
      font-weight: bold;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

   
    .sound-progress-box {
      border: 1px solid #000;
      position: absolute;
      top: 40px;
      left: 40px;
      background: #fff;
      padding: 8px 14px;
      font-size: 14px;
      z-index: 10;
      transition: all 0.3s ease;
    }

    .sound-progress-box.training-active {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #d4f4d1;
      border: 2px solid #2f6b28;
      font-size: 20px;
      font-weight: bold;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }


  </style>
</head>
<body>


<div class="modal" id="infoBoxModal">
  <div class="modal-content">
    <h2>Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î³Î¹Î± Ï„Î¿ Î ÎµÎ¯ÏÎ±Î¼Î±</h2>
    <p style="text-align: left; line-height: 1.6;">
      Î“Î¹Î± Î½Î± Î±ÎºÎ¿ÏÏƒÎµÏ„Îµ Ï„Î¿Î½ Î®Ï‡Î¿ Ï€Î±Ï„Î®ÏƒÏ„Îµ Ï„Î¿ <strong>ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ ÎºÎ¿Ï…Î¼Ï€Î¯</strong> (Î® Ï„Î¿ <strong>Ï€Î»Î®ÎºÏ„ÏÎ¿ A</strong> ÏƒÏ„Î¿ Ï€Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î¹Î¿), ÎµÎ½Ï Î³Î¹Î± Î½Î± Î±ÎºÎ¿ÏÏƒÎµÏ„Îµ Ï„Î¿ Î·Î¼Î¯Ï„Î¿Î½Î¿ <strong>Ï€Î±Ï„Î®ÏƒÏ„Îµ (click) Ï€Î¬Î½Ï‰ ÏƒÏ„Î¿ slider</strong>.<br>
      Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ‰ÏƒÏ„Î­Ï‚ Î® Î»Î¬Î¸Î¿Ï‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚ â€“ Î¼Î±Ï‚ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎµÎ¹ Î½Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎ¿Ï…Î¼Îµ Ï„Î· Î´Î¹ÎºÎ® ÏƒÎ±Ï‚ <strong>Ï…Ï€Î¿ÎºÎµÎ¹Î¼Î­Î½Î¹ÎºÎ® Î±Î½Ï„Î¯Î»Î·ÏˆÎ· Î³Î¹Î± Ï„Î¿ Ï„Î¿Î½Î¹ÎºÏŒ ÏÏˆÎ¿Ï‚</strong>.<br>
    </p>
  </div>
</div> 

<div class="modal" id="consentModal">
  <div class="modal-content">
    <h2>Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î³Î¹Î± Ï„Î¿ Î ÎµÎ¯ÏÎ±Î¼Î±</h2>
    <p style="text-align: left; line-height: 1.6;">
      Î£Î±Ï‚ ÎµÏ…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ Î³Î¹Î± Ï„Î· ÏƒÏ…Î¼Î¼ÎµÏ„Î¿Ï‡Î® ÏƒÎ±Ï‚ ÏƒÏ„Î¿ Ï€ÎµÎ¯ÏÎ±Î¼Î±!<br><br>
      ÎœÎ­ÏƒÏ‰ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Ï€ÎµÎ¹ÏÎ¬Î¼Î±Ï„Î¿Ï‚ Î¸Î­Î»Î¿Ï…Î¼Îµ Î½Î± Î¼ÎµÎ»ÎµÏ„Î®ÏƒÎ¿Ï…Î¼Îµ Ï„Î·Î½ <strong>Î±Î½Ï„Î¯Î»Î·ÏˆÎ· Ï„Î¿Ï… Ï„Î¿Î½Î¹ÎºÎ¿Ï ÏÏˆÎ¿Ï…Ï‚ Ï„Î¿Î½Î¹ÎºÎ¬ Î±ÎºÎ±Î¸ÏŒÏÎ¹ÏƒÏ„Ï‰Î½ Î®Ï‡Ï‰Î½ - Î¸Î¿ÏÏÎ²Ï‰Î½</strong>.<br>
      Î˜Î± Î±ÎºÎ¿ÏÏƒÎµÏ„Îµ Î¼Î¹Î± ÏƒÎµÎ¹ÏÎ¬ Î±Ï€ÏŒ Î®Ï‡Î¿Ï…Ï‚. Î“Î¹Î± ÎºÎ¬Î¸Îµ Î®Ï‡Î¿, Î¸Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡Î¯ÏƒÎµÏ„Îµ Ï„Î¿ Ï„Î¿Î½Î¹ÎºÏŒ Ï„Î¿Ï… ÏÏˆÎ¿Ï‚ (pitch) Î¼Îµ ÎµÎºÎµÎ¯Î½Î¿ ÎµÎ½ÏŒÏ‚ Î·Î¼Î¯Ï„oÎ½Î¿Ï… (sinewave) Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ slider ÏƒÏ„Î·Î½ Î¿Î¸ÏŒÎ½Î·.<br><br>

      Î“Î¹Î± Î½Î± Î±ÎºÎ¿ÏÏƒÎµÏ„Îµ Ï„Î¿Î½ Î®Ï‡Î¿ Ï€Î±Ï„Î®ÏƒÏ„Îµ Ï„Î¿ <strong>ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ ÎºÎ¿Ï…Î¼Ï€Î¯</strong> (Î® <strong>Ï„Î¿ Ï€Î»Î®ÎºÏ„ÏÎ¿ A</strong> ÏƒÏ„Î¿ Ï€Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î¹Î¿), ÎµÎ½Ï Î³Î¹Î± Î½Î± Î±ÎºÎ¿ÏÏƒÎµÏ„Îµ Ï„Î¿ Î·Î¼Î¯Ï„Î¿Î½Î¿ <strong>Ï€Î±Ï„Î®ÏƒÏ„Îµ (click) Ï€Î¬Î½Ï‰ ÏƒÏ„Î¿ slider</strong>.<br>
      Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ‰ÏƒÏ„Î­Ï‚ Î® Î»Î¬Î¸Î¿Ï‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚ â€“ Î¼Î±Ï‚ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎµÎ¹ Î½Î± ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÎ¿Ï…Î¼Îµ Ï„Î· Î´Î¹ÎºÎ® ÏƒÎ±Ï‚ <strong>Ï…Ï€Î¿ÎºÎµÎ¹Î¼Î­Î½Î¹ÎºÎ® Î±Î½Ï„Î¯Î»Î·ÏˆÎ· Î³Î¹Î± Ï„Î¿ Ï„Î¿Î½Î¹ÎºÏŒ ÏÏˆÎ¿Ï‚</strong>.<br><br>

      Î— ÏƒÏ…Î¼Î¼ÎµÏ„Î¿Ï‡Î® ÏƒÎ±Ï‚ ÏƒÏ„Î¿ Ï€ÎµÎ¯ÏÎ±Î¼Î± ÎµÎ¯Î½Î±Î¹ <strong>ÎµÎ¸ÎµÎ»Î¿Î½Ï„Î¹ÎºÎ®</strong> ÎºÎ±Î¹ ÎµÎ¯ÏƒÏ„Îµ ÎµÎ»ÎµÏÎ¸ÎµÏÎ¿Î¹ Î½Î± Î±Ï€Î¿Ï‡Ï‰ÏÎ®ÏƒÎµÏ„Îµ Î±Î½Î¬ Ï€Î¬ÏƒÎ± ÏƒÏ„Î¹Î³Î¼Î® Ï‡Ï‰ÏÎ¯Ï‚ Ï€ÎµÏÎ±Î¹Ï„Î­ÏÏ‰ ÏƒÏ…Î½Î­Ï€ÎµÎ¹ÎµÏ‚.
      Î¤Î¿ Ï€ÎµÎ¯ÏÎ±Î¼Î± Î­Ï‡ÎµÎ¹ Î»Î¬Î²ÎµÎ¹ Î¬Î´ÎµÎ¹Î± Î±Ï€ÏŒ Ï„Î·Î½ <strong>Î•Ï€Î¹Ï„ÏÎ¿Ï€Î® Î—Î¸Î¹ÎºÎ®Ï‚ ÎºÎ±Î¹ Î”ÎµÎ¿Î½Ï„Î¿Î»Î¿Î³Î¯Î±Ï‚ Ï„Î·Ï‚ ÎˆÏÎµÏ…Î½Î±Ï‚ Ï„Î¿Ï… Î‘Î Î˜</strong>.<br><br>

      Î£Î±Ï‚ ÎµÏ…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ ÎºÎ±Î¹ Ï€Î¬Î»Î¹ Î³Î¹Î± Ï„Î· ÏƒÏ…Î½ÎµÏÎ³Î±ÏƒÎ¯Î± ÏƒÎ±Ï‚!!
    </p>
    <button class="start-btn" id="consent-continue-btn">Î£Ï…Î½ÎµÏ‡Î¯ÏƒÏ„Îµ</button>
  </div>
</div>  

<div class="modal" id="introModal" style="display: none;">
  <div class="modal-content">
    <h2>ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸Î±Ï„Îµ</h2>
    <p>
      Î Î±ÏÎ±ÎºÎ±Î»Î¿ÏÎ¼Îµ ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï€ÏÎ¹Î½ Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÏ„Îµ:
    </p>
    <form id="userInfoForm" style="text-align: left; font-size: 16px;">
      <label for="gender">Î¦ÏÎ»Î¿:</label><br>
      <!-- <input type="text" id="gender" name="gender" required><br><br> -->
      <select id="gender" name="gender" required>
        <option value="" disabled selected>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ...</option>
        <option>Î†ÏÏÎµÎ½</option>
        <option>Î˜Î®Î»Ï…</option>
        <option>Î†Î»Î»Î¿</option>
        <option>Î”ÎµÎ½ Î±Ï€Î±Î½Ï„Ï</option>
      </select><br><br>

      <label for="experience">Î•Ï€Î¯Ï€ÎµÎ´Î¿ ÎµÎ¼Ï€ÎµÎ¹ÏÎ¯Î±Ï‚ Î¼Îµ Ï„Î· Î¼Î¿Ï…ÏƒÎ¹ÎºÎ®:</label><br>
      <select id="experience" name="experience" required>
        <option value="" disabled selected>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ...</option>
        <option>Î•Ï€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¯Î±Ï‚ ÎœÎ¿Ï…ÏƒÎ¹ÎºÏŒÏ‚</option>
        <option>Î—Î¼Î¹-ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¯Î±Ï‚</option>
        <option>Î•ÏÎ±ÏƒÎ¹Ï„Î­Ï‡Î½Î·Ï‚</option>
        <option>Î›Î¬Ï„ÏÎ·Ï‚ Ï„Î·Ï‚ Î¼Î¿Ï…ÏƒÎ¹ÎºÎ®Ï‚</option>
        <option>Î‘Ï€Î»ÏŒÏ‚ Î±ÎºÏÎ¿Î±Ï„Î®Ï‚</option>
      </select><br><br>

      <label>Î Î±Î¯Î¶ÎµÏ„Îµ ÎºÎ¬Ï€Î¿Î¹Î¿ Î¼Î¿Ï…ÏƒÎ¹ÎºÏŒ ÏŒÏÎ³Î±Î½Î¿;</label><br>
      <input type="radio" name="instrument" value="yes" required> ÎÎ±Î¹<br>
      <input type="radio" name="instrument" value="no"> ÎŒÏ‡Î¹<br><br>

      <div id="instrumentNameField" style="display: none;">
        <label for="instrumentName">Î‘Î½ Î½Î±Î¹, Ï€Î¿Î¹Î¿;</label><br>
        <input type="text" id="instrumentName" name="instrumentName"><br><br>
      </div>

      <label for="equipment">Î¤Î¹ Î±ÎºÎ¿Ï…ÏƒÏ„Î¹ÎºÏŒ ÎµÎ¾Î¿Ï€Î»Î¹ÏƒÎ¼ÏŒ Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î³Î¹Î± Ï„Î¿ Ï€ÎµÎ¯ÏÎ±Î¼Î±;</label><br>
      <select id="equipment" name="equipment" required>
        <option value="" disabled selected>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ...</option>
        <option>ÎšÎ»ÎµÎ¹ÏƒÏ„Î¿Ï Î¤ÏÏ€Î¿Ï… (Over - Ear)</option>
        <option>Î‘ÎºÎ¿Ï…ÏƒÏ„Î¹ÎºÎ¬ ÏˆÎµÎ¯ÏÎµÏ‚ (In - Ear)</option>
        <option>Î•Ï€Î¯ Ï„Î¿Ï… Î‘Ï…Ï„Î¹Î¿Ï (On - Ear)</option>
        <option>Monitors</option>
      </select><br><br>

      <label>ÎÎ­ÏÎµÏ„Îµ Ï„Î¹ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Î¤Î¿Î½Î¹ÎºÏŒ ÎÏˆÎ¿Ï‚;</label><br>
      <input type="radio" name="knowPitch" value="yes" required> ÎÎ±Î¹<br>
      <input type="radio" name="knowPitch" value="no"> ÎŒÏ‡Î¹<br><br>

      <div id="pitchExplanation" style="display: none; margin-top: 20px;">
        <strong>Î¤Î¹ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Î¤Î¿Î½Î¹ÎºÏŒ ÎÏˆÎ¿Ï‚:</strong><br>
        Î¦Î±Î½Ï„Î±ÏƒÏ„ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ Î±ÎºÎ¿ÏÏ„Îµ Î´Î¹Î¬Ï†Î¿ÏÎµÏ‚ Ï†Ï‰Î½Î­Ï‚. ÎšÎ¬Ï€Î¿Î¹ÎµÏ‚ Ï†Ï‰Î½Î­Ï‚ ÎµÎ¯Î½Î±Î¹ ÏˆÎ·Î»Î­Ï‚ ÎºÎ±Î¹ Î»ÎµÏ€Ï„Î­Ï‚, ÏƒÎ±Î½ Ï„Î· Ï†Ï‰Î½Î® ÎµÎ½ÏŒÏ‚ Î¼Î¹ÎºÏÎ¿Ï Ï€Î±Î¹Î´Î¹Î¿Ï Î® ÎµÎ½ÏŒÏ‚ ÏƒÏ†Ï…ÏÎ¯Î³Î¼Î±Ï„Î¿Ï‚.<br>
        Î†Î»Î»ÎµÏ‚ Ï†Ï‰Î½Î­Ï‚ ÎµÎ¯Î½Î±Î¹ Ï‡Î±Î¼Î·Î»Î­Ï‚ ÎºÎ±Î¹ Î²Î±Î¸Î¹Î­Ï‚, ÏƒÎ±Î½ Ï„Î· Ï†Ï‰Î½Î® ÎµÎ½ÏŒÏ‚ Î¬Î½Ï„ÏÎ± Î¼Îµ Î¼Ï€Î¬ÏƒÎ± Ï†Ï‰Î½Î® Î® Ï„Î¿Î½ Î²ÏÏ…Ï‡Î·Î¸Î¼ÏŒ ÎµÎ½ÏŒÏ‚ Î»Î¹Î¿Î½Ï„Î±ÏÎ¹Î¿Ï.<br>
        <em>Î‘Ï…Ï„Î® Î· Î±Î¯ÏƒÎ¸Î·ÏƒÎ· Ï„Î¿Ï… Ï€ÏŒÏƒÎ¿ ÏˆÎ·Î»ÏŒÏ‚ Î® Ï€ÏŒÏƒÎ¿ Ï‡Î±Î¼Î·Î»ÏŒÏ‚ ÎµÎ¯Î½Î±Î¹ Î­Î½Î±Ï‚ Î®Ï‡Î¿Ï‚, Î±Ï…Ï„ÏŒ Î»Î­Î¼Îµ Ï„Î¿Î½Î¹ÎºÏŒ ÏÏˆÎ¿Ï‚.</em>
      </div><br>

      <strong> Î‘ÏÏ‡Î¹ÎºÎ¬ Î¸Î± Î±ÎºÎ¿ÏÏƒÎµÏ„Îµ Ï„ÏÎµÎ¹Ï‚ ÎµÎ½Î´ÎµÎ¹ÎºÏ„Î¹ÎºÎ¿ÏÏ‚ Î®Ï‡Î¿Ï…Ï‚ Î³Î¹Î± Î½Î± ÎµÎ¾Î¿Î¹ÎºÎµÎ¹Ï‰Î¸ÎµÎ¯Ï„Îµ Î¼Îµ Ï„Î¿ Ï€ÎµÎ¯ÏÎ±Î¼Î± ÎºÎ±Î¹ Î½Î± ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ„Îµ Ï„Î·Î½ Î­Î½Ï„Î±ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ…ÏƒÎºÎµÏ…Î®Ï‚ ÏƒÎ±Ï‚, Î· Î¿Ï€Î¿Î¯Î± Î¸Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î¼ÎµÏ„Î­Ï€ÎµÎ¹Ï„Î± Î½Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½ÎµÎ¹ ÏƒÏ„Î±Î¸ÎµÏÎ®.
        ÎŸÎ¹ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚ ÏƒÎ±Ï‚ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· Ï†Î¬ÏƒÎ· Î´Îµ Î¸Î± ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î¿ÏÎ½.</strong><br><br>

      <div style="display: flex; justify-content: center; margin-top: 20px;">
        <button type="submit" class="start-btn" id="start-btn">ÎˆÎ½Î±ÏÎ¾Î·</button>
      </div>

    </form>
  </div>
</div>


<div class="modal" id="thankYouModal" style="display: none;">
  <div class="modal-content">
    <h2>Î£Î±Ï‚ ÎµÏ…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ!</h2>
    <p>
      Î— ÏƒÏ…Î¼Î¼ÎµÏ„Î¿Ï‡Î® ÏƒÎ±Ï‚ ÏƒÏ„Î¿ ÎµÏÏ‰Ï„Î·Î¼Î±Ï„Î¿Î»ÏŒÎ³Î¹Î¿ Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±.<br>
      Î•ÎºÏ„Î¹Î¼Î¿ÏÎ¼Îµ Ï„Î¿Î½ Ï‡ÏÏŒÎ½Î¿ ÎºÎ±Î¹ Ï„Î· ÏƒÏ…Î¼Î²Î¿Î»Î® ÏƒÎ±Ï‚ ÏƒÏ„Î·Î½ Î­ÏÎµÏ…Î½Î±.
    </p>
    <!-- <button class="start-btn" onclick="location.reload()">Î•Ï€Î±Î½ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·</button> -->
  </div>
</div>

<!-- Main Content -->
<div class="questionnaire__container" id="questionnaireContent">
    <h2 class="questionnaire__title">Î¤Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÏ„Îµ Ï„Î¿ slider ÏƒÏ„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ Ï€Î¿Ï… Ï€Î¹ÏƒÏ„ÎµÏÎµÏ„Îµ ÏŒÏ„Î¹ Ï„Î¿ Ï„Î¿Î½Î¹ÎºÏŒ ÏÏˆÎ¿Ï‚ (pitch) Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯ ÏƒÏ„Î¿ ÎµÎºÎ¬ÏƒÏ„Î¿Ï„Îµ Î·Ï‡Î·Ï„Î¹ÎºÏŒ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±</h2>
    <div class="questionnaire__info-box" id="questionnaire__info-box">i</div>
    <div class="questionnaire__main-content">
        <!-- Buttons -->
        <div style="display: flex; align-items: center; gap: 10px;">
          <button id="samplePlayBtn" class="questionnaire__audio-play-button">
            <span id="sampleIcon">â–¶</span><br>Î Î±Ï„Î®ÏƒÏ„Îµ "A" Î® ÎºÎ»Î¹ÎºÎ¬ÏÎµÏ„Îµ Î³Î¹Î± Î½Î± Ï€Î±Î¯Î¾ÎµÏ„Îµ Ï„Î¿Î½ Î®Ï‡Î¿
          </button>
          <div class="loop-toggle-wrapper">
            <div class="loop-arrow">â†</div>
            <button id="loopToggleBtn" class="questionnaire__loop-toggle">Loop: OFF</button>
          </div>
        </div>
        
        <div class="label">Î£Ï…Ï‡Î½ÏŒÏ„Î·Ï„Î± (Hz)</div>
        <input class="questionnaire__sinewave-slider" type="range" id="sineSlider" min="40" max="6000" step="1" value="440" disabled>
        <button class="questionnaire__no-match-button" id="no-match">Î”ÎµÎ½ Î²ÏÎ¯ÏƒÎºÏ‰ Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ·</button>
        <button class="start-btn" id="next">Î•Ï€ÏŒÎ¼ÎµÎ½Î¿Ï‚ Î®Ï‡Î¿Ï‚</button>
    </div> 
    <div id="soundProgressBox" class="sound-progress-box">
      Î‰Ï‡Î¿Ï‚ 1 Î±Ï€ÏŒ 19
    </div>
    
</div>

<script>


function generateSessionId() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
    const r = Math.random() * 16 | 0,
          v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}


const sessionId = generateSessionId();


let audioContext = null;
let osc = null;
let sineGain = null;
let isSinePlaying = false;


const sineSlider = document.getElementById("sineSlider");
const startBtn = document.getElementById("start-btn");
const consentModal = document.getElementById("consentModal");
const consentBtn = document.getElementById("consent-continue-btn");
const modal = document.getElementById("introModal");
const questionnaire = document.getElementById("questionnaireContent");
const questionnaireInfoBox = document.getElementById("questionnaire__info-box");
const infoBoxModal = document.getElementById("infoBoxModal");

function initAudioContext() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  } else if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
}

// Reference ISO 226 values for 60 phons
const loudnessReference = [
  { f: 20, spl: 12.5 },
  { f: 50, spl: 17.3 },
  { f: 100, spl: 20.3 },
  { f: 200, spl: 21.5 },
  { f: 400, spl: 23.0 },
  { f: 800, spl: 27.5 },
  { f: 1000, spl: 26.0 },
  { f: 2000, spl: 24.5 },
  { f: 4000, spl: 24.0 },
  { f: 8000, spl: 26.5 },
  { f: 10000, spl: 30.0 },
  { f: 12000, spl: 35.5 },
  { f: 16000, spl: 30.0 }
];

// Normalize gain curve (lower SPL = more sensitive = higher gain)
const minSPL = Math.min(...loudnessReference.map(p => p.spl));

const normalizedGainPoints = loudnessReference.map(p => ({
  f: p.f,
  gain: Math.pow(10, (minSPL - p.spl) / 20) // inverse dB â†’ linear
}));



function loudnessCompensation(frequency) {
  const freq = Math.max(20, Math.min(16000, frequency)); // clamp range

  // Interpolation over log scale
  for (let i = 0; i < normalizedGainPoints.length - 1; i++) {
    const p1 = normalizedGainPoints[i];
    const p2 = normalizedGainPoints[i + 1];

    if (freq >= p1.f && freq <= p2.f) {
      const logF = Math.log10(freq);
      const logF1 = Math.log10(p1.f);
      const logF2 = Math.log10(p2.f);
      const t = (logF - logF1) / (logF2 - logF1);

      return p1.gain * (1 - t) + p2.gain * t; // linear interp in gain
    }
  }

  return 1.0; // fallback
}

const minFreq = 40;
const maxFreq = 3000;

function startSinewave(frequency) {
  if (!audioContext || audioContext.state === 'suspended') return;

  if (osc) {
    osc.stop();
    osc.disconnect();
  }

  osc = audioContext.createOscillator();
  osc.frequency.value = frequency;
  osc.type = "sine";

  sineGain = audioContext.createGain();
  const baseGain = 0.8;
  sineGain.gain.value = baseGain * loudnessCompensation(frequency);

  osc.connect(sineGain).connect(audioContext.destination);
  osc.start();

  isSinePlaying = true;
}

function stopSinewave() {
  if (osc && sineGain) {
    const now = audioContext.currentTime;

    // Smoothly ramp the gain to 0
    sineGain.gain.setTargetAtTime(0, now, 0.01); // 10ms exponential fade

    // Stop oscillator slightly after fade ends
    osc.stop(now + 0.05); // gives time to finish the fade

    // Disconnect after stop (slightly delayed cleanup)
    setTimeout(() => {
      osc.disconnect();
      osc = null;
      isSinePlaying = false;
    }, 60); // allow the 50ms to pass before cleanup
  } else {
    isSinePlaying = false;
  }
}


// Event listeners for slider interaction
sineSlider.addEventListener("mousedown", () => {
  startSinewave(parseFloat(sineSlider.value));
});

sineSlider.addEventListener("input", (event) => {
  const freq = parseFloat(event.target.value);

  // If not already playing, start the wave
  if (!isSinePlaying) startSinewave(freq);

  // Update frequency and gain dynamically
  if (osc) osc.frequency.value = freq;
  if (sineGain) {
    const baseGain = 0.8;
    sineGain.gain.setTargetAtTime(
      baseGain * loudnessCompensation(freq),
      audioContext.currentTime,
      0.01 // smooth transition in 10ms
    );
  }
});

sineSlider.addEventListener("mouseup", stopSinewave);
sineSlider.addEventListener("touchend", stopSinewave);

// Start button inside modal
// startBtn.addEventListener("click", () => {
//   initAudioContext();
//   sineSlider.disabled = false;
//   modal.style.display = "none";
//   // questionnaire.style.display = "flex";
// });

consentBtn.addEventListener("click", () => {
  consentModal.style.display = "none";
  modal.style.display = "flex";
});

questionnaireInfoBox.addEventListener("click", () => {
  infoBoxModal.style.display = "flex";
});

// Close modal when clicking outside modal content
infoBoxModal.addEventListener("click", (e) => {
  if (e.target === infoBoxModal) {
    infoBoxModal.style.display = "none";
  }
});

document.querySelectorAll('input[name="instrument"]').forEach((el) => {
  el.addEventListener("change", () => {
    const instrumentField = document.getElementById("instrumentNameField");
    if (el.value === "yes") {
      instrumentField.style.display = "block";
      document.getElementById("instrumentName").required = true;
    } else {
      instrumentField.style.display = "none";
      document.getElementById("instrumentName").value = "";
      document.getElementById("instrumentName").required = false;
    }
  });
});

document.querySelectorAll('input[name="knowPitch"]').forEach((el) => {
  el.addEventListener("change", () => {
    const explanation = document.getElementById("pitchExplanation");
    if (el.value === "no") {
      explanation.style.display = "block";
    } else {
      explanation.style.display = "none";
    }
  });
});


const userForm = document.getElementById("userInfoForm");


// Î¥Ï€Î¿Î²Î¿Î»Î® Ï†ÏŒÏÎ¼Î±Ï‚
userForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  // Ensure all required fields are valid
  if (!userForm.checkValidity()) {
    userForm.reportValidity(); // Show native browser validation UI
    return;
  }

  const userInfo = {
    session_id: sessionId,
    gender: document.getElementById("gender").value.trim(),
    music_experience: document.getElementById("experience").value,
    plays_instrument: document.querySelector('input[name="instrument"]:checked')?.value === "yes",
    instrument_name: document.getElementById("instrumentName").value.trim(),
    equipment: document.getElementById("equipment").value,
    knows_pitch: document.querySelector('input[name="knowPitch"]:checked')?.value === "yes",
  };


  try {
    const res = await fetch("/save_indefinite_pitch_user_info", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(userInfo),
    });

    if (res.ok) {
      initAudioContext();
      sineSlider.disabled = false;
      introModal.style.display = "none";
      questionnaire.style.display = "flex";
      await fetchSounds(); // if needed
    } else {
      alert("Î Î±ÏÎ¿Ï…ÏƒÎ¹Î¬ÏƒÏ„Î·ÎºÎµ Ï€ÏÏŒÎ²Î»Î·Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Ï‰Î½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½.");
    }
  } catch (err) {
    console.error("âŒ Error saving user info:", err);
    alert("Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® Ï„Ï‰Î½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½.");
  }
});







let sampleBuffer = null;
let sampleSource = null;
let isSamplePlaying = false;
let loopEnabled = false;

const noMatchButton = document.getElementById("no-match");
let noMatchClicked = false;

const loopToggleBtn = document.getElementById("loopToggleBtn");
const samplePlayBtn = document.getElementById("samplePlayBtn");

loopToggleBtn.addEventListener("click", () => {
  loopEnabled = !loopEnabled;
  loopToggleBtn.textContent = loopEnabled ? "Loop: ON" : "Loop: OFF";

  // If loop is being turned OFF while sample is playing, apply it
  if (!loopEnabled && isSamplePlaying && sampleSource) {
    sampleSource.loop = false;
    // Let it stop naturally on next end
  }
});

noMatchButton.addEventListener("click", () => {
  noMatchClicked = !noMatchClicked;
  noMatchButton.classList.toggle("active", noMatchClicked);
  sineSlider.classList.toggle("slider-locked", noMatchClicked);
});


sineSlider.addEventListener("mousedown", () => {
  if (noMatchClicked) {
    // Reset no-match state
    noMatchClicked = false;
    noMatchButton.classList.remove("active");
    sineSlider.classList.remove("slider-locked");
  }
});

sineSlider.addEventListener("touchstart", () => {
  if (noMatchClicked) {
    noMatchClicked = false;
    noMatchButton.classList.remove("active");
    sineSlider.classList.remove("slider-locked");
  }
});





// Load the sample once after AudioContext is allowed
function loadSample(url) {
  return fetch(url)
    .then(response => response.arrayBuffer())
    .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
    .then(decodedData => {
      sampleBuffer = decodedData;
    });
}

// Play or stop sample
function toggleSample() {
  if (!audioContext || !sampleBuffer) return;

  if (isSamplePlaying) {
    stopSample();
  } else {
    playSample();
  }
}

const sampleIcon = document.getElementById("sampleIcon");

function playSample() {
  if (!audioContext || !sampleBuffer) return;

  // If already playing, stop it
  if (isSamplePlaying) {
    stopSample();
    return;
  }

  sampleSource = audioContext.createBufferSource();
  sampleSource.buffer = sampleBuffer;
  sampleSource.loop = loopEnabled;
  sampleSource.connect(audioContext.destination);

  sampleSource.onended = () => {
    isSamplePlaying = false;
    sampleSource = null;
    if (sampleIcon) {
      sampleIcon.textContent = "â–¶"; // reset icon
      sampleIcon.style.fontSize = "20px";
    }
  };

  sampleSource.start();
  isSamplePlaying = true;
  if (sampleIcon) {
    sampleIcon.textContent = "â– "; // show stop iconâ¹
    sampleIcon.style.fontSize = "20px";

  }
}

function stopSample() {
  if (sampleSource) {
    sampleSource.stop();
    sampleSource.disconnect();
    sampleSource = null;
    isSamplePlaying = false;
    if (sampleIcon) {
      sampleIcon.textContent = "â–¶"; // reset icon
      sampleIcon.style.fontSize = "20px";
    }
  }
}


// Load the sample after user clicks "Start"
// startBtn.addEventListener("click", async () => {
//   initAudioContext();
//   sineSlider.disabled = false;
//   modal.style.display = "none";
//   await fetchSoundList(); // triggers random sound list and starts 1st sound
// });

// ğŸ” Use both hotkey & click to toggle
document.addEventListener("keydown", (e) => {
  if (e.key === "a" || e.key === "A") {
    toggleSample();
  }
});

samplePlayBtn.addEventListener("click", toggleSample);



let soundList = [];
let currentSoundIndex = 0;

async function fetchSoundList() {
  const res = await fetch("/get_sounds");
  soundList = await res.json();
  currentSoundIndex = 0;
  loadCurrentSound();
}

let isTrainingPhase = true; // ğŸ‘‰ Î¾ÎµÎºÎ¹Î½Î¬Î¼Îµ Î¼Îµ training

async function fetchSounds() {
  const endpoint = isTrainingPhase
    ? "/get_sounds_training"
    : "/get_sounds";

  const res = await fetch(endpoint);
  soundList = await res.json();
  currentSoundIndex = 0;
  loadCurrentSound();
}

function updateSoundProgressDisplay() {
  const box = document.getElementById("soundProgressBox");
  const label = isTrainingPhase ? "Î•Î½Î´ÎµÎ¹ÎºÏ„Î¹ÎºÏŒÏ‚ Î‰Ï‡Î¿Ï‚" : "Î‰Ï‡Î¿Ï‚";
  box.textContent = `${label} ${currentSoundIndex + 1} Î±Ï€ÏŒ ${soundList.length}`;

  if (isTrainingPhase) {
    box.classList.add("training-active");
  } else {
    box.classList.remove("training-active");
  }
}

async function loadCurrentSound() {
  const file = soundList[currentSoundIndex];
  const folder = isTrainingPhase ? "indefinite_pitch/training" : "indefinite_pitch";
  const response = await fetch(`/static/${folder}/${file}`);
  const buffer = await response.arrayBuffer();
  sampleBuffer = await audioContext.decodeAudioData(buffer);
  updateSoundProgressDisplay();
}


document.getElementById("next").addEventListener("click", async () => {
  const currentSound = soundList[currentSoundIndex];

  // ğŸ‘‰ Î‘Î½ Î”Î•Î ÎµÎ¯Î½Î±Î¹ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ® Ï†Î¬ÏƒÎ·, ÏƒÏÏƒÎµ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±
  if (!isTrainingPhase) {
    const responseData = {
      session_id: sessionId,
      sound: currentSound,
      response: {
        frequency: noMatchClicked ? 0 : parseFloat(sineSlider.value),
        cannotMapPitch: noMatchClicked,
        timestamp: new Date().toISOString()
      },
    };

    await fetch("/save_responses_indefinite_pitch", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(responseData),
    });
  }

  stopSample();

  currentSoundIndex++;
  sineSlider.value = 440;

  if (currentSoundIndex >= soundList.length) {
    if (isTrainingPhase) {
      // ğŸ‘‰ Î•ÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ· Ï„Î­Î»Î¿Ï‚ â†’ Î¾ÎµÎºÎ¹Î½Î¬ÎµÎ¹ Ï„Î¿ Ï€ÎµÎ¯ÏÎ±Î¼Î±
      isTrainingPhase = false;
      currentSoundIndex = 0;
      await fetchSounds(); // ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬ stimuli
      document.getElementById("next").textContent = "Î•Ï€ÏŒÎ¼ÎµÎ½Î¿Ï‚ Î‰Ï‡Î¿Ï‚";
      return;
    }

    // ğŸ‘‰ Î¤Î­Î»Î¿Ï‚ ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¿Ï Ï€ÎµÎ¹ÏÎ¬Î¼Î±Ï„Î¿Ï‚
    document.getElementById("thankYouModal").style.display = "flex";
  } else {
    if (!isTrainingPhase && currentSoundIndex === soundList.length - 1) {
      document.getElementById("next").textContent = "ÎŸÏÎ¹ÏƒÏ„Î¹ÎºÎ® Ï…Ï€Î¿Î²Î¿Î»Î®";
    }
    await loadCurrentSound();
    stopSample();
    isSamplePlaying = false;
  }

  // Reset UI state
  noMatchClicked = false;
  noMatchButton?.classList.remove("active");
  sineSlider?.classList.remove("slider-locked");
});






</script>

</body>
</html>
